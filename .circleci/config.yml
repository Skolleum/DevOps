version: 2.1
orbs:
  terraform: circleci/terraform@3.1.0
  azure-cli: circleci/azure-cli@1.2.2

jobs:
  gundb_container:
    working_directory: ~/build
    docker:
      - image: cimg/base:current
    resource_class: medium
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.7
      - run:
          name: "Clone gundb"
          command: "git clone 'https://github.com/amark/gun.git'"
      - run:
          name: "Build gundb container"
          command: "docker build -t ghcr.io/skolleum/gundb:$CIRCLE_BUILD_NUM -t ghcr.io/skolleum/gundb:latest ."
          working_directory: ~/build/gun
      - run:
          name: "Login to github container registery"
          command: "echo $GITHUB_TOKEN | docker login ghcr.io -u AkkokUgurcan --password-stdin"
      - run:
          name: "Push gundb image"
          command: "docker push ghcr.io/skolleum/gundb:$CIRCLE_BUILD_NUM"
      - run:
          name: "Push gundb image as latest"
          command: "docker push ghcr.io/skolleum/gundb:latest"
  eth_container:
    working_directory: ~/build
    docker:
      - image: cimg/base:current
    resource_class: medium
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
          version: 20.10.7
      - run:
          name: "Clone SmartContracts"
          command: "git clone -b cicd 'https://github.com/Skolleum/SmartContract.git'"
      - run:
          name: "Build smart contracts container"
          command: "docker build -t ghcr.io/skolleum/eth:$CIRCLE_BUILD_NUM -t ghcr.io/skolleum/eth:latest ."
          working_directory: ~/build/SmartContract
      - run:
          name: "Login to github container registery"
          command: "echo $GITHUB_TOKEN | docker login ghcr.io -u AkkokUgurcan --password-stdin"
      - run:
          name: "Push smart contract (eth) image"
          command: "docker push ghcr.io/skolleum/eth:$CIRCLE_BUILD_NUM"
      - run:
          name: "Push smart contract (eth) image as latest"
          command: "docker push ghcr.io/skolleum/eth:latest"
  provision:
    executor: 
      terraform/default:
        tag: 1.1
    steps:
      - checkout
      - terraform/init:
          path: ./nodevm
      - terraform/validate:
          path: ./nodevm
      - terraform/plan:
          path: ./nodevm
      - terraform/apply:
          path: ./nodevm

workflows:
  dependencies:
    jobs:
      - gundb_container
      - eth_container
  deploy:
    jobs:
      - provision

